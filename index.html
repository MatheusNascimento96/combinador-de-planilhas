<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Match - Combinador de Planilhas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-container {
            position: relative;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .file-input-container:hover {
            background-color: #f8fafc;
            border-color: #94a3b8;
        }
        .file-input-container input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-900">Combinador Inteligente de Planilhas</h1>
            <p class="text-slate-500 mt-2">Compare duas planilhas e encontre correspondências por aproximação.</p>
        </header>

        <main id="main-content">
            <!-- Seção de Upload e Configuração -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Coluna da Base 1 -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-slate-700 border-b pb-2">Base de Dados 1 (A pesquisar)</h2>
                    <div id="file-drop-zone-1" class="file-input-container">
                        <span id="file-name-1" class="text-slate-500">Arraste e solte o arquivo ou clique aqui</span>
                        <input type="file" id="base1-file" accept=".xlsx, .xls, .csv">
                    </div>
                    <div>
                        <label for="base1-sheet" class="block text-sm font-medium text-slate-600">Selecione a Aba</label>
                        <select id="base1-sheet" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200" disabled>
                            <option value="">Selecione um arquivo primeiro</option>
                        </select>
                    </div>
                    <div>
                        <label for="base1-column" class="block text-sm font-medium text-slate-600">Selecione a Coluna</label>
                         <select id="base1-column" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200" disabled>
                            <option value="">Selecione uma aba primeiro</option>
                        </select>
                    </div>
                </div>

                <!-- Coluna da Base 2 -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-slate-700 border-b pb-2">Base de Dados 2 (Onde pesquisar)</h2>
                     <div id="file-drop-zone-2" class="file-input-container">
                        <span id="file-name-2" class="text-slate-500">Arraste e solte o arquivo ou clique aqui</span>
                        <input type="file" id="base2-file" accept=".xlsx, .xls, .csv">
                    </div>
                    <div>
                        <label for="base2-sheet" class="block text-sm font-medium text-slate-600">Selecione a Aba</label>
                         <select id="base2-sheet" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200" disabled>
                            <option value="">Selecione um arquivo primeiro</option>
                        </select>
                    </div>
                    <div>
                        <label for="base2-column" class="block text-sm font-medium text-slate-600">Selecione a Coluna</label>
                        <select id="base2-column" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200" disabled>
                            <option value="">Selecione uma aba primeiro</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Seção de Pontuação e Botão -->
            <div class="mt-8 pt-6 border-t">
                <div class="flex flex-col sm:flex-row items-center justify-center gap-6">
                    <div>
                        <label for="score-threshold" class="block text-sm font-medium text-slate-600 text-center">Pontuação Mínima de Similaridade (%)</label>
                        <input type="number" id="score-threshold" value="85" min="0" max="100" class="mt-1 w-32 px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-center text-lg">
                    </div>
                    <button id="process-button" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Combinar Planilhas
                    </button>
                </div>
            </div>

            <!-- Seção de Resultados -->
            <div id="results-section" class="mt-10 hidden">
                <div id="status-container" class="flex items-center justify-center gap-4 p-4 rounded-lg bg-slate-100">
                    <div id="loader" class="loader hidden"></div>
                    <p id="status-message" class="font-medium"></p>
                </div>

                <div id="download-container" class="text-center mt-6 hidden">
                     <button id="download-button" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-all shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Download do Resultado
                    </button>
                </div>
                
                <div class="mt-6 overflow-x-auto">
                    <h3 class="text-lg font-semibold mb-2">Prévia dos Resultados:</h3>
                    <table id="results-table" class="min-w-full bg-white border border-slate-200">
                        <!-- O cabeçalho e as linhas da tabela serão inseridos via JavaScript -->
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Biblioteca para ler Excel. A lógica de Fuzzy Match agora é interna. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        // VERIFICAÇÃO DE BIBLIOTECA XLSX
        if (typeof XLSX === 'undefined') {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="p-4 rounded-md bg-red-50 text-red-700 text-center">
                    <h3 class="text-lg font-bold">Erro Crítico de Carregamento</h3>
                    <p class="mt-2">Não foi possível carregar a biblioteca para leitura de planilhas.</p>
                    <p class="mt-1">Por favor, <strong>verifique sua conexão com a internet</strong>, <strong>desative bloqueadores de anúncio (AdBlock)</strong> e <strong>recarregue a página</strong>.</p>
                </div>
            `;
            return;
        }

        // --- INÍCIO DA LÓGICA DE SIMILARIDADE (LEVENSHTEIN) ---
        /**
         * Calcula a distância Levenshtein entre duas strings.
         * A distância é o número mínimo de edições de um caractere (inserções, exclusões ou substituições)
         * necessárias para transformar uma string na outra.
         * @param {string} s1 A primeira string.
         * @param {string} s2 A segunda string.
         * @returns {number} A distância de Levenshtein.
         */
        const levenshteinDistance = (s1, s2) => {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        };

        /**
         * Calcula a porcentagem de similaridade entre duas strings com base na distância de Levenshtein.
         * @param {string} s1 A primeira string.
         * @param {string} s2 A segunda string.
         * @returns {number} A similaridade em porcentagem (0-100).
         */
        const calculateSimilarity = (s1, s2) => {
            let longer = s1;
            let shorter = s2;
            if (s1.length < s2.length) {
                longer = s2;
                shorter = s1;
            }
            const longerLength = longer.length;
            if (longerLength === 0) {
                return 100;
            }
            const distance = levenshteinDistance(longer, shorter);
            return ((longerLength - distance) / longerLength) * 100;
        };
        // --- FIM DA LÓGICA DE SIMILARIDADE ---


        // Armazena os resultados finais e os arquivos carregados
        let finalResults = [];
        let file1, file2;

        // Lógica para arrastar e soltar arquivos
        function setupFileDrop(zoneId, inputId, nameId, fileVarSetter, sheetSelectId, columnSelectId) {
            const dropZone = document.getElementById(zoneId);
            const fileInput = document.getElementById(inputId);
            const fileNameSpan = document.getElementById(nameId);

            const handleFile = (selectedFile) => {
                if (!selectedFile) return;
                fileNameSpan.textContent = selectedFile.name;
                fileVarSetter(selectedFile);
                populateSheetDropdown(selectedFile, sheetSelectId, columnSelectId);
            };

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-blue-50', 'border-blue-400'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('bg-blue-50', 'border-blue-400'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('bg-blue-50', 'border-blue-400');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFile(fileInput.files[0]);
                }
            });
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    handleFile(fileInput.files[0]);
                } else {
                    fileNameSpan.textContent = 'Arraste e solte o arquivo ou clique aqui';
                }
            });
        }

        // Função para popular a lista de abas (sheets)
        async function populateSheetDropdown(file, sheetSelectId, columnSelectId) {
            const sheetSelect = document.getElementById(sheetSelectId);
            const columnSelect = document.getElementById(columnSelectId);

            sheetSelect.innerHTML = '<option value="">Carregando abas...</option>';
            sheetSelect.disabled = true;
            columnSelect.innerHTML = '<option value="">Selecione uma aba primeiro</option>';
            columnSelect.disabled = true;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                sheetSelect.innerHTML = '<option value="">Selecione uma aba</option>';
                workbook.SheetNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    sheetSelect.appendChild(option);
                });
                sheetSelect.disabled = false;
            } catch (error) {
                showStatus(`Erro ao ler as abas do arquivo: ${error.message}`, false, true);
                sheetSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Função para popular a lista de colunas
        async function populateColumnDropdown(file, sheetName, columnSelectId) {
            if (!file || !sheetName) return;

            const columnSelect = document.getElementById(columnSelectId);
            columnSelect.innerHTML = '<option value="">Carregando colunas...</option>';
            columnSelect.disabled = true;

            try {
                const data = await readExcelFile(file, sheetName);
                if (!data.length) {
                    throw new Error("A aba selecionada está vazia.");
                }
                
                columnSelect.innerHTML = '<option value="">Selecione uma coluna</option>';
                const headers = Object.keys(data[0]);
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    columnSelect.appendChild(option);
                });
                columnSelect.disabled = false;
            } catch (error) {
                showStatus(`Erro ao ler as colunas: ${error.message}`, false, true);
                columnSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Inicialização
        setupFileDrop('file-drop-zone-1', 'base1-file', 'file-name-1', (f) => file1 = f, 'base1-sheet', 'base1-column');
        setupFileDrop('file-drop-zone-2', 'base2-file', 'file-name-2', (f) => file2 = f, 'base2-sheet', 'base2-column');
        
        document.getElementById('base1-sheet').addEventListener('change', (e) => populateColumnDropdown(file1, e.target.value, 'base1-column'));
        document.getElementById('base2-sheet').addEventListener('change', (e) => populateColumnDropdown(file2, e.target.value, 'base2-column'));


        const processButton = document.getElementById('process-button');
        const downloadButton = document.getElementById('download-button');
        const resultsSection = document.getElementById('results-section');
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const loader = document.getElementById('loader');
        const downloadContainer = document.getElementById('download-container');

        function readExcelFile(file, sheetName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const worksheet = workbook.Sheets[sheetName];
                        if (!worksheet) {
                            reject(new Error(`Aba "${sheetName}" não encontrada no arquivo.`));
                            return;
                        }
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                        resolve(jsonData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = (error) => reject(new Error("Ocorreu um erro ao tentar ler o arquivo."));
                reader.readAsArrayBuffer(file);
            });
        }

        function showStatus(message, isLoading = false, isError = false) {
            resultsSection.classList.remove('hidden');
            statusContainer.classList.remove('hidden');
            statusMessage.textContent = message;

            if (isError) {
                statusMessage.classList.remove('text-slate-600');
                statusMessage.classList.add('text-red-600');
                loader.classList.add('hidden');
            } else {
                statusMessage.classList.remove('text-red-600');
                statusMessage.classList.add('text-slate-600');
                if (isLoading) {
                    loader.classList.remove('hidden');
                    downloadContainer.classList.add('hidden');
                } else {
                    loader.classList.add('hidden');
                }
            }
        }

        function displayResultsPreview(data) {
            const table = document.getElementById('results-table');
            table.innerHTML = ''; 
            if (data.length === 0) return;

            const previewData = data.slice(0, 10);
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.className = 'bg-slate-100';
            const headers = Object.keys(previewData[0]);
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.className = 'px-4 py-2 text-left text-sm font-semibold text-slate-600';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            previewData.forEach(rowData => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-200';
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = rowData[header];
                    td.className = 'px-4 py-2 text-sm text-slate-700';
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
        }
        
        processButton.addEventListener('click', async () => {
            const sheet1 = document.getElementById('base1-sheet').value;
            const column1 = document.getElementById('base1-column').value;
            const sheet2 = document.getElementById('base2-sheet').value;
            const column2 = document.getElementById('base2-column').value;
            const scoreThreshold = parseInt(document.getElementById('score-threshold').value, 10);

            if (!file1 || !file2 || !sheet1 || !column1 || !sheet2 || !column2) {
                showStatus('Por favor, selecione os arquivos, abas e colunas para continuar.', false, true);
                return;
            }

            showStatus('Iniciando o processamento...', true);
            try {
                showStatus('Lendo os dados das planilhas...', true);
                const data1 = await readExcelFile(file1, sheet1);
                const data2 = await readExcelFile(file2, sheet2);

                if (!data1.length || !data2.length) {
                    throw new Error("Um dos arquivos ou abas selecionadas está vazio.");
                }
                
                showStatus(`Combinando ${data1.length} registros... Isso pode levar um momento.`, true);
                
                const matches = [];

                await new Promise(resolve => setTimeout(resolve, 50)); // Libera a UI para atualizar

                data1.forEach((row1) => {
                    const query = String(row1[column1] || '');
                    if (!query) return;

                    let bestMatch = { score: -1, row: null, value: null };

                    data2.forEach((row2) => {
                        const choice = String(row2[column2] || '');
                        if (!choice) return;

                        const score = calculateSimilarity(query, choice);
                        if (score > bestMatch.score) {
                            bestMatch = { score: score, row: row2, value: choice };
                        }
                    });

                    if (bestMatch.score >= scoreThreshold) {
                        const suffixedRow2 = {};
                        for (const key in bestMatch.row) {
                            suffixedRow2[`${key}_base2`] = bestMatch.row[key];
                        }
                        
                        matches.push({
                            'Chave_Base1': query, ...row1,
                            'Chave_Encontrada_Base2': bestMatch.value,
                            'Score': Math.round(bestMatch.score), ...suffixedRow2,
                        });
                    }
                });

                finalResults = matches;

                if (finalResults.length > 0) {
                    showStatus(`Processo concluído! ${finalResults.length} correspondências encontradas.`);
                    downloadContainer.classList.remove('hidden');
                    displayResultsPreview(finalResults);
                } else {
                    showStatus('Nenhuma correspondência encontrada com a pontuação mínima especificada.', false, true);
                    document.getElementById('results-table').innerHTML = '';
                    downloadContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error(error);
                showStatus(`Erro: ${error.message}`, false, true);
            }
        });

        downloadButton.addEventListener('click', () => {
            if (finalResults.length === 0) {
                showStatus('Não há dados para download.', false, true);
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(finalResults);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Resultados');
            XLSX.writeFile(workbook, 'Resultado_Combinado.xlsx');
        });
    });
</script>

</body>
</html>

